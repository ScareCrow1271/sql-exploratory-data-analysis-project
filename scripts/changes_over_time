
 -- Analyze sales performance over time
 ;WITH yearly_sales AS (
	SELECT 
		YEAR(order_date) AS order_year,
 		SUM(sales_amount) AS total_sales,
        COUNT(DISTINCT customer_key) AS total_customers,
        SUM(quantity) AS total_quantity
		FROM gold.fact_sales
		WHERE order_date IS NOT NULL 
		GROUP BY YEAR(order_date)
  )

 SELECT order_year,
 total_sales,
 total_customers,
 total_quantity,
 CAST(ROUND(total_sales * 100.00 / SUM(total_sales) OVER(), 2) AS DECIMAL(5, 2)) AS sales_contribution,
 CAST(ROUND(total_customers * 100.00 / SUM(total_customers) OVER(), 2) AS DECIMAL(5, 2)) AS customer_contribution
 FROM yearly_sales 
 ORDER BY order_year;
 

 SELECT 
 YEAR(order_date) AS order_year,
 SUM(sales_amount) AS total_sales,
 COUNT(DISTINCT customer_key) AS total_customers,
 SUM(quantity) AS total_quantity
 FROM gold.fact_sales
 WHERE order_date IS NOT NULL 
 GROUP BY YEAR(order_date)
 ORDER BY YEAR(order_date);


 SELECT YEAR(order_date) AS order_year,
 MONTH(order_date) AS order_month,
 SUM(sales_amount) AS total_sales,
 COUNT(DISTINCT customer_key) AS total_customers,
 SUM(quantity) AS total_quantity
 FROM gold.fact_sales
 WHERE order_date IS NOT NULL 
 GROUP BY YEAR(order_date), MONTH(order_date)
 ORDER BY YEAR(order_date), MONTH(order_date);
 
 -- Can use DateTrunc Function -->
 SELECT DATETRUNC(month, order_date) AS order_date,
 SUM(sales_amount) AS total_sales,
 COUNT(DISTINCT customer_key) AS total_customers,
 SUM(quantity) AS total_quantity
 FROM gold.fact_sales
 WHERE order_date IS NOT NULL 
 GROUP BY DATETRUNC(month, order_date)
 ORDER BY DATETRUNC(month, order_date);
 
  -- Can use Format Function -->
  -- Only for Report, not suitable for data analysis

 SELECT FORMAT(order_date, 'yyyy-MMM') AS order_date,
 SUM(sales_amount) AS total_sales,
 COUNT(DISTINCT customer_key) AS total_customers,
 SUM(quantity) AS total_quantity
 FROM gold.fact_sales
 WHERE order_date IS NOT NULL 
 GROUP BY FORMAT(order_date, 'yyyy-MMM')
 ORDER BY FORMAT(order_date, 'yyyy-MMM');
 
